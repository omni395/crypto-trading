# Crypto Trading Platform

---

## Оглавление
1. [Описание](#описание)
2. [Технологии](#технологии)
3. [Структура проекта](#структура-проекта)
4. [Основной функционал](#основной-функционал)
5. [Логика работы приложения](#логика-работы-приложения)
6. [Пользовательские фильтры](#пользовательские-фильтры)
7. [Поиск по монетам](#поиск-по-монетам)
8. [Архитектура контроллеров](#архитектура-контроллеров)
9. [Кеширование и оптимизация](#кеширование-и-оптимизация)
10. [Интеграция с биржами](#интеграция-с-биржами)
11. [Иконки криптовалют](#отображение-иконок-криптовалют)
12. [TODO и планы](#todo-и-планы)

---

## Описание
Веб-приложение для мониторинга и анализа криптовалютных инструментов с поддержкой фильтрации, избранного, realtime-обновлений и пользовательских настроек. Работает для авторизованных и неавторизованных пользователей.

## Технологии
- **Ruby on Rails** — backend и API
- **Hotwire (Turbo/Stimulus)** — динамика и realtime UI
- **TailwindCSS/Flowbite** — стилизация
- **PostgreSQL** — база данных
- **Redis** — кеш и pub/sub
- **Sidekiq** — фоновые задачи
- **Docker Compose** — контейнеризация
- **Vite** — сборка фронта (JS, CSS, HMR)
- **Pinia** — управление состоянием
- **Vue** — фронтенд
- **ECharts** — интерактивные графики
- **Toastr** — уведомления

## Структура проекта
- `app/frontend` — фронтенд-код (Vue, JS, CSS, entrypoints для Vite)
- `app/assets/builds` — production-ассеты
- `app/controllers` — контроллеры Rails (API и страницы)
- `app/services` — бизнес-логика, кеширование, интеграции
- `app/jobs` — фоновые задачи (Sidekiq)
- `pg-data`, `redis-data`, `bundle`, `node_modules` — временные данные и зависимости

## Основной функционал
- Загрузка и обновление списка торговых пар с Binance (spot/futures)
- Инкрементальное обновление монет: добавление новых, обновление изменённых, деактивация исчезнувших
- Live-поиск по монетам на клиенте (поиск по base_asset, symbol, name)
- Пользовательские фильтры и настройки (котируемая валюта, статус, биржа и др.)
- Автоматическое обновление списка монет при изменении фильтров
- Для неавторизованных — дефолтные фильтры
- Отображение актуальных данных и графиков по инструментам
- Realtime-обновление графиков через WebSocket
- Авторизация через Google (omniauth)
- Уведомления через Toastr
- Избранные монеты (TODO)

## Логика работы приложения
1. При открытии страницы загружается список монет по фильтрам пользователя (или дефолтным).
2. Пользователь может открыть модалку настроек, изменить фильтры и сохранить новые значения.
3. После сохранения настроек instruments-frame автоматически обновляется и показывает новый список монет по обновлённым фильтрам.
4. Live-поиск по монетам работает только на клиенте: при вводе в поле поиска список монет фильтруется по base_asset, symbol и name прямо в браузере, без дополнительных запросов к серверу.
5. Избранные монеты (TODO) не фильтруются и будут отображаться отдельным списком.

## Пользовательские фильтры
- Все фильтры (объём, сделки, изменение, цена и др.) хранятся в поле `settings` пользователя
- Для неавторизованных — дефолтные значения
- При открытии страницы/модалки настройки подставляются из базы (или дефолтные)
- После сохранения — новые значения используются для фильтрации монет
- Фильтрация по бирже, статусу, валюте и др. динамическая

## Поиск по монетам
- Live search реализован на клиенте: поиск по base_asset, symbol и name среди уже отфильтрованных монет.
- Нет лишних запросов к API и серверу: поиск мгновенный и не зависит от сети.
- Для глобального поиска по всей базе монет потребуется отдельная доработка (не реализовано).

### Поиск и фильтрация монет

- **Поле поиска** теперь занимает всю ширину контейнера, что обеспечивает удобный ввод даже длинных названий монет. Отступы по бокам соответствуют дизайну.
- **Визуальное выделение сортировки:**
  - При выборе сортировки по объёму, сделкам, изменению (%) или цене соответствующее значение в каждой карточке монеты выделяется ярким цветом, жирным шрифтом и подчёркиванием.
  - Остальные значения отображаются теми же цветами, но более бледными (opacity 0.85), чтобы акцент был только на выбранном фильтре.
  - Для объёма и сделок используются иконки вместо текстовых подписей.
  - Объём и сделки теперь выводятся в одну строку для компактности.

### Пример отображения

| Сортировка | Выделение |
|------------|-----------|
| Объём      | Ярко-голубой, жирный, подчёркнутый объём, остальные бледнее |
| Сделок     | Ярко-фиолетовый, жирный, подчёркнутый сделки, остальные бледнее |
| Изм. %     | Ярко-зелёный/красный, жирный, подчёркнутый процент, остальные бледнее |
| Цена       | Белый, жирный, подчёркнутый цена, остальные бледнее |

### UI/UX
- Используются современные иконки FontAwesome для визуального разделения объёма и сделок.
- Все элементы адаптированы под компактный и чистый вид.

## Архитектура контроллеров
### Backend (Ruby on Rails)
- **MainController** — формирует главную страницу, фильтры, список монет
- **Api::InstrumentsController**
  - `index` — отфильтрованный список монет
  - `favorites` — избранные монеты (если реализовано)
- **Api::UserSettingsController**
  - `show` — текущие настройки пользователя
  - `update` — сохранение новых настроек
- **Users::OmniauthCallbacksController** — авторизация через Google

## Кеширование и оптимизация
- Для ускорения выдачи монет реализовано кеширование "сырых" тикеров по базовым фильтрам (exchange, quote_asset, status) в Redis.
- TTL кеша — 6 минут (данные обновляются либо фоновой Sidekiq-джобой, либо первым пользовательским запросом после истечения TTL).
- Фильтрация по объёму, цене, изменению и другим числовым параметрам выполняется на лету в контроллере.
- Для популярных фильтров кеш обновляется автоматически через InstrumentsCacheJob (Sidekiq, каждые 5 минут).
- Для ускорения загрузки тикеров с биржи используется batch API (если поддерживается биржей), что позволяет получать данные сразу по всем монетам одним запросом.

### Основные файлы и сервисы кеширования
- `app/services/instruments_cache_service.rb` — кеш "сырых" тикеров по базовым фильтрам
- `app/jobs/instruments_cache_job.rb` — фоновое обновление кеша популярных фильтров
- `app/services/exchange_adapter.rb` — загрузка тикеров с биржи (batch/индивидуально), кеширование по монетам
- `app/controllers/api/dynamics_controller.rb` — отдаёт монеты, сначала проверяя кеш, затем фильтруя по пользовательским условиям

### Как работает кеширование
1. При запросе к /api/dynamics сначала ищется кеш по базовым фильтрам.
2. Если кеш найден — тикеры фильтруются по пользовательским условиям (min_volume, min_price и др.) в Ruby.
3. Если кеша нет — тикеры загружаются с биржи (batch-запросом), кладутся в кеш, затем фильтруются.
4. Фоновая джоба обновляет кеш популярных фильтров, чтобы пользователи всегда получали быстрый отклик.

## Интеграция с биржами

### Универсальный адаптер для бирж
- Реализован универсальный адаптер для работы с разными биржами через единый интерфейс
- Поддержка как спотового, так и фьючерсного рынков
- Динамическая конфигурация через базу данных

### Конфигурация бирж
Каждая биржа в системе имеет следующие настройки:
- `api_url` - URL для получения списка торговых пар
- `batch_api_url` - URL для получения тикеров (batch-запрос)
- `chart_url` - URL для получения исторических данных
- `websocket_url` - URL для WebSocket соединения
- `websocket_klines_format` - формат данных для WebSocket
- `websocket_klines_mapping` - маппинг полей WebSocket данных

### Управление биржами
- Административная панель для управления биржами
- Возможность добавления новых бирж
- Редактирование существующих бирж
- Управление статусом биржи (активна/неактивна)

### Фетчер криптовалют
- Универсальный сервис для получения списка торговых пар
- Автоматическое обновление списка при изменении на бирже
- Поддержка инкрементальных обновлений
- Обработка ошибок и повторные попытки

### WebSocket интеграция
- Поддержка realtime-обновлений через WebSocket
- Конфигурируемый формат данных для каждой биржи
- Автоматическое переподключение при разрыве соединения
- Кеширование последних данных

### Безопасность
- Валидация всех входящих данных
- Проверка форматов URL и JSON
- Защита от некорректных данных
- Логирование ошибок и проблем

## Отображение иконок криптовалют
- Основной CDN: [binance-icons](https://github.com/VadimMalykhin/binance-icons) через CDN: `https://cdn.jsdelivr.net/gh/vadimmalykhin/binance-icons/crypto/[base_asset].svg`
- Fallback: https://cryptoicons.org/api/icon/[base_asset]/32
- Если иконка не найдена — серая иконка FontAwesome (`fa-circle-question`)
- Для корректной работы FontAwesome подключите CDN: `<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">`

## TODO и планы
- Избранные монеты: отдельный список, не фильтруются, localStorage/профиль
- Drag-and-drop сортировка монет
- Добавить открытый интерес
- Добавить возможность добавления монет в избранное
- Добавить возможность удаления монет из избранного
- Добавить возможность редактирования монет в избранном

---
Для подробностей см. комментарии в исходных файлах и описание компонентов.
