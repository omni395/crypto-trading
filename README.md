# Crypto Trading Platform

## Технологии

- **Ruby on Rails** — основной backend и API.
- **Hotwire (Turbo/Stimulus)** — динамика и realtime UI.
- **TailwindCSS/Flowbite** — стилизация интерфейса.
- **PostgreSQL** — база данных.
- **Redis** — кеш и pub/sub.
- **Sidekiq** — фоновые задачи.
- **Docker Compose** — контейнеризация и масштабирование.
- **Vite** — современный сборщик фронтенда (JS, CSS, HMR), интеграция с TailwindCSS.
- **HAML** — шаблоны.

## Основные возможности

- Загрузка и обновление списка всех торговых пар с Binance каждые 5 минут (автоматически)
- Инкрементальное обновление монет (spot и futures):
  - Добавляет только новые монеты
  - Обновляет только изменившиеся
  - Помечает как `inactive` исчезнувшие
- **Быстрый поиск монет** (live search через Turbo/Stimulus, сброс фильтра при очистке поля)
- **Пользовательские фильтры и настройки** через модальное окно (тип рынка, котируемая валюта, статус, биржа и др.)
- Персональные настройки фильтров сохраняются через API `/api/user_settings` (GET/PATCH)
- После сохранения настроек список монет автоматически обновляется с учётом новых фильтров
- Для неавторизованных пользователей используются дефолтные фильтры
- Отображение актуальных данных и графиков по выбранным инструментам
- Realtime-обновление данных графика через ActionCable (WebSocket)
- Возможность авторизации через Google (omniauth)
- Модульные компоненты интерфейса на Hotwire/Stimulus
- Фоновые задачи и обработка данных через Sidekiq
- Docker-окружение для быстрой разработки и деплоя
- Уведомления реализованы через Toastr и jQuery

## Функции сброса настроек и обновления монет

### Сброс настроек к дефолтным
- В модальном окне настроек пользователя есть кнопка "По дефолту".
- При нажатии настройки сбрасываются к значениям из DEFAULT_SETTINGS (см. модель User).
- Сброс реализован через PATCH-запрос к `/api/user_settings`.
- После сброса список монет автоматически обновляется по новым (дефолтным) фильтрам.

### Принудительное обновление монет с Binance
- Кнопка "Обновить монеты" доступна **только пользователям с ролью admin** (см. систему ролей выше).
- При нажатии появляется подтверждающее окно (confirm).
- После подтверждения отправляется POST-запрос на `/api/admin/refresh_binance`.
- Бэкенд вручную обновляет пары spot и futures через сервисы BinanceSpotCryptocurrenciesFetcher и BinanceFuturesCryptocurrenciesFetcher.
- После завершения отображается уведомление об успехе или ошибке.
- Доступность кнопки и API защищены через Pundit (policy(:admin).refresh_binance?).

## Логика работы пользовательских фильтров и настроек

- Все настройки фильтров (мин. объем торгов, мин. количество сделок, изменение за 24ч, цена выше, цена ниже и др.) хранятся в поле `settings` пользователя.
- Для неавторизованных пользователей используются дефолтные значения (см. DEFAULT_SETTINGS в модели User).
- При открытии страницы или модального окна настройки автоматически подставляются из базы (или дефолтные).
- После изменения и сохранения настроек (PATCH `/api/user_settings`) новые значения сохраняются в базе и используются для фильтрации монет.
- **Выбор биржи временно недоступен:** поле "Биржа по умолчанию" отображается неактивным, и фильтрация всегда производится только по бирже Binance.
- Все остальные фильтры (рынок, валюта, статус, объем, сделки, изменение, цена) работают в обычном режиме.

## Структура проекта

- `app/frontend` — весь фронтенд-код (Stimulus, JS, CSS, entrypoints для Vite)
- `app/assets/builds` — production-ассеты (игнорируются в git)
- `pg-data`, `redis-data`, `bundle`, `node_modules` — временные данные и зависимости (игнорируются в git)

## Функциональные контроллеры и их задачи

### Бэкенд (Ruby on Rails)

- **MainController** — формирует главную страницу, подготавливает фильтры и список монет для отображения, поддерживает живой поиск по монетам.
- **Api::InstrumentsController**
  - `index` — возвращает список монет, отфильтрованных по пользовательским или дефолтным настройкам.
  - `favorites` — возвращает избранные монеты пользователя (если реализовано).
- **Api::UserSettingsController**
  - `show` — отдаёт текущие настройки пользователя (или дефолтные, если не авторизован).
  - `update` — сохраняет новые пользовательские настройки фильтров через PATCH-запрос.
- **Users::OmniauthCallbacksController** — реализует авторизацию через Google (OAuth2).

### Фронтенд (Stimulus Controllers)

- **instruments_controller.js** — управляет отображением и обновлением списка монет, получает данные через Turbo Streams/API, реагирует на изменение фильтров.
- **instruments_search_controller.js** — реализует быстрый поиск по монетам, сбрасывает фильтр при очистке поля, отправляет запросы для поиска.
- **user_settings_controller.js** — управляет модальным окном настроек, отправляет PATCH-запросы для сохранения фильтров, поддерживает сброс к дефолтным значениям.
- **index.js/application.js** — регистрирует и инициализирует все Stimulus-контроллеры.

## Пример сценария работы:

1. Пользователь открывает страницу — загружается список монет по его фильтрам (или дефолтным).
2. Открывает модальное окно настроек, меняет фильтры (тип рынка, валюту и пр.), сохраняет — настройки отправляются через API, список монет обновляется.
3. Быстрый поиск по монетам работает без перезагрузки страницы.
4. Для авторизованных пользователей сохраняются избранные монеты и настройки.
5. Все изменения моментально отражаются на UI через Turbo/Stimulus.

## Актуальная архитектура фильтров и настроек

- Список монет (`instruments-frame`) всегда отображает монеты, отфильтрованные по актуальным настройкам пользователя (или дефолтным, если не авторизован).
- Пользователь может открыть модалку настроек, изменить фильтры и сохранить новые значения.
- После сохранения настроек instruments-frame автоматически обновляется и показывает новый список монет по обновлённым фильтрам.
- Все фильтры и поиск реализованы через Turbo Frames + Stimulus Controllers, без прямой работы с localStorage.
- Для сохранения и получения настроек используется API `/api/user_settings` (GET/PATCH).

## Автоматическая фильтрация и обновление списка монет

### Как работает фильтрация инструментов (монет)

- При открытии страницы или turbo-frame с монетами, сервер фильтрует список монет по настройкам пользователя (или дефолтным, если пользователь не авторизован).
- Настройки пользователя (market_type, quote_asset, status, exchange) сохраняются через модальное окно.
- После сохранения настроек отправляется событие `settings:updated`, который ловит Stimulus-контроллер `instruments`.
- Контроллер автоматически обновляет turbo-frame с монетами без перезагрузки всей страницы.
- В консоли браузера выводятся логи о количестве монет после обновления.

### Как добавить новую биржу

- В таблице `cryptocurrencies` есть поле `exchange` (по умолчанию `binance`).
- Для поддержки других бирж добавьте соответствующие значения в это поле при загрузке новых монет.
- Фильтрация по бирже будет работать автоматически через настройки пользователя.

### Ключевые файлы

- `app/controllers/main_controller.rb` — фильтрация монет по настройкам пользователя.
- `app/components/instruments_component.html.erb` — рендер списка монет с data-crypto-row.
- `app/frontend/controllers/instruments_controller.js` — слушает событие `settings:updated`, обновляет turbo-frame и логирует результат.
- `db/migrate/20250426211620_add_exchange_to_cryptocurrencies.rb` — миграция для поддержки поля `exchange`.

### Как проверить работу

1. Откройте страницу с инструментами.
2. Измените фильтры в настройках пользователя и сохраните.
3. Turbo-frame обновится автоматически, в консоли появится лог о количестве монет.
4. Список монет всегда соответствует актуальным фильтрам пользователя (или дефолтным).

## Администрирование и роли

- Система ролей реализована через отдельные таблицы `roles` и `user_roles` (многие-ко-многим).
- Для разграничения доступа используется Pundit (policy-based authorization).
- Админ-панель доступна только пользователям с ролью `admin`:
  - Управление ролями: `/admin/roles`
  - Назначение ролей пользователям: `/admin/user_roles`
- Для проверки прав во view и контроллерах используется: `policy(:admin).admin?`
- Все действия, доступные только админам, теперь проверяются единой политикой `admin?` (универсальная проверка, не привязанная к конкретному действию).
- Интерфейс управления ролями и назначениями стал более современным и читаемым (цвета, бейджи, отступы, тени, адаптивность).
- Кнопки управления ролями и назначениями доступны только в дропдауне пользователя для админов.

## Кеширование и производительность

- Используется Redis для кеширования часто используемых данных:
  - Списки торговых пар по quote_asset (FilteredPairsService) — TTL 10 минут
  - Уникальные значения для фильтров (market_type, status, quote_asset) — TTL 10 минут
- Это ускоряет работу фильтров и уменьшает нагрузку на базу данных.

## Улучшения интерфейса (2025)

- Обновлён дизайн таблиц ролей и назначений ролей: добавлены цвета, шрифты, плавные эффекты, бейджи, современный вид.
- Админские действия вынесены в дропдаун пользователя.
- Весь интерфейс стал более адаптивным и приятным для работы с большим количеством данных.

## TODO и планы развития

- [ ] Избранные монеты: добавить отдельный список избранного пользователя, который не фильтруется и отображается отдельно.
- [ ] Доработка админки: улучшить формы создания/редактирования ролей, добавить фильтры и поиск по пользователям.
- [ ] Расширить кеширование для сложных фильтров и агрегатов.

---

# История изменений (Changelog)

- **2025.04:**
  - Унификация проверки админских прав через `policy(:admin).admin?` вместо привязки к конкретным действиям
  - Вынесение админских функций в дропдаун пользователя
  - Улучшение дизайна таблиц ролей и назначений ролей
  - Кеширование справочников фильтров (market_type, status, quote_asset)
  - Общий рефакторинг и структурирование кода

---

**Cascade рекомендует:**
- Очищено: устаревшие js-контроллеры и дублирующие partials удалены
- Вся логика фильтров и поиска централизована через сервер и Stimulus
- В layout оставлены только необходимые подключения (jQuery, Toastr, Turbo, Vite)
- Для уведомлений используется партиал _toastr.html.erb без дублирования кода

## Быстрый старт через Docker Compose

1. Склонируйте репозиторий и перейдите в папку проекта.
2. Запустите:
   ```sh
   docker-compose up --build
   ```
3. При старте контейнера web автоматически выполняются миграции и seed:
   - `rails db:migrate && rails db:seed && rails s -b 0.0.0.0`
4. После запуска:
   - Откройте http://localhost:3000
   - Войдите как admin@example.com / 12345678 для доступа к админ-панели ролей.

## Прочее

- Для изменения ролей или пользователей используйте админ-панель или консоль Rails.
- Все миграции и сиды выполняются автоматически при запуске web-контейнера.

## TODO

1. Добавить поля сортировки
2. Выбор монет для главного графика
3. Добавить график на главный фрейм
4. Добавить карточку монеты на главный фрейм
5. Модификация главного фрейма и графика
6. Добавить возможность избранных монет:
    - Пользователь может добавить монету в избранное (favorite).
    - Избранные монеты не фильтруются обычными фильтрами и отображаются отдельным списком.
    - Для неавторизованных пользователей избранное хранить в localStorage, для авторизованных — в профиле пользователя.
7. Реализовать drag-and-drop для сортировки монет
8. Внедрить быстрые пресеты фильтров
9. Добавить историю поиска и быстрый возврат к последним запросам

---

**Cascade рекомендует:**
- Очищено: устаревшие js-контроллеры и дублирующие partials удалены
- Вся логика фильтров и поиска централизована через сервер и Stimulus
- В layout оставлены только необходимые подключения (jQuery, Toastr, Turbo, Vite)
- Для уведомлений используется партиал _toastr.html.erb без дублирования кода
