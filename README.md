# Crypto Trading Platform

## Описание

Веб-приложение для мониторинга и анализа криптовалютных инструментов с поддержкой фильтрации, избранного, realtime-обновлений и кастомных пользовательских настроек. Поддерживает работу как для авторизованных, так и для неавторизованных пользователей.

## Технологии

- **Ruby on Rails** — основной backend и API
- **Hotwire (Turbo/Stimulus)** — динамика и realtime UI
- **TailwindCSS/Flowbite** — стилизация интерфейса
- **PostgreSQL** — база данных
- **Redis** — кеш и pub/sub
- **Sidekiq** — фоновые задачи
- **Docker Compose** — контейнеризация и масштабирование
- **Vite** — сборка фронтенда (JS, CSS, HMR)
- **Pinia** — управление состоянием
- **Vue** — фронтенд
- **Toastr** — уведомления


## Функционал и что планируется.

- Загрузка и обновление списка торговых пар с Binance (spot/futures)
- Инкрементальное обновление монет: добавление новых, обновление изменённых, деактивация исчезнувших
- Быстрый live-поиск по монетам - нужно перенести на vue
- Пользовательские фильтры и настройки (котируемая валюта, статус, биржа и др.)
- Сохранение фильтров через API, автоматическое обновление списка монет
- Для неавторизованных пользователей — дефолтные фильтры
- Отображение актуальных данных и графиков по инструментам
- Realtime-обновление графиков через WebSocket
- Авторизация через Google (omniauth)
- Модульные компоненты на Hotwire/Stimulus
- Docker-окружение для разработки и деплоя
- Уведомления через Toastr и jQuery
- Избранные монеты (TODO)

## Структура проекта

- `app/frontend` — фронтенд-код (Stimulus, JS, CSS, entrypoints для Vite)
- `app/assets/builds` — production-ассеты
- `pg-data`, `redis-data`, `bundle`, `node_modules` — временные данные и зависимости

## Логика работы приложения

1. При открытии страницы загружается список монет по фильтрам пользователя (или дефолтным).
2. Пользователь может открыть модалку настроек, изменить фильтры и сохранить новые значения.
3. После сохранения настроек список монет автоматически обновляется.
4. Избранные монеты (TODO) не фильтруются и будут отображаться отдельным списком.

## Логика пользовательских фильтров

- Все фильтры (объём, сделки, изменение, цена и др.) хранятся в поле `settings` пользователя
- Для неавторизованных — дефолтные значения
- При открытии страницы/модалки настройки подставляются из базы (или дефолтные)
- После сохранения — новые значения используются для фильтрации монет
- Фильтрация по бирже, статусу, валюте и др. динамическая

## Архитектура контроллеров

### Backend (Ruby on Rails)
- **MainController** — формирует главную страницу, фильтры, список монет, live search
- **Api::InstrumentsController**
  - `index` — отфильтрованный список монет
  - `favorites` — избранные монеты (если реализовано)
- **Api::UserSettingsController**
  - `show` — текущие настройки пользователя
  - `update` — сохранение новых настроек
- **Users::OmniauthCallbacksController** — авторизация через Google

## Оптимизация скорости загрузки инструментов (2025)

- Для ускорения выдачи монет реализовано кеширование "сырых" тикеров по базовым фильтрам (exchange, quote_asset, status) в Redis.
- TTL кеша — 6 минут (данные обновляются либо фоновой Sidekiq-джобой, либо первым пользовательским запросом после истечения TTL).
- Фильтрация по объёму, цене, изменению и другим числовым параметрам выполняется на лету в контроллере.
- Для популярных фильтров кеш обновляется автоматически через InstrumentsCacheJob (Sidekiq, каждые 5 минут).
- Для ускорения загрузки тикеров с биржи используется batch API (если поддерживается биржей), что позволяет получать данные сразу по всем монетам одним запросом.

## Основные файлы и сервисы кеширования
- `app/services/instruments_cache_service.rb` — кеш "сырых" тикеров по базовым фильтрам
- `app/jobs/instruments_cache_job.rb` — фоновое обновление кеша популярных фильтров
- `app/services/exchange_adapter.rb` — загрузка тикеров с биржи (batch/индивидуально), кеширование по монетам
- `app/controllers/api/dynamics_controller.rb` — отдаёт монеты, сначала проверяя кеш, затем фильтруя по пользовательским условиям

## Как работает кеширование
1. При запросе к /api/dynamics сначала ищется кеш по базовым фильтрам.
2. Если кеш найден — тикеры фильтруются по пользовательским условиям (min_volume, min_price и др.) в Ruby.
3. Если кеша нет — тикеры загружаются с биржи (batch-запросом), кладутся в кеш, затем фильтруются.
4. Фоновая джоба обновляет кеш популярных фильтров, чтобы пользователи всегда получали быстрый отклик.

## Примечания
- Если требуется изменить TTL кеша или период фоновой джобы — корректировать в instruments_cache_service.rb и sidekiq_cron.rb соответственно.
- Для избранных монет (TODO) планируется отдельная логика отображения вне фильтров.

## Важно

- Все фильтры и настройки динамические, live search работает без перезагрузки ( - нужно перенести на vue)
- Для авторизованных сохраняются избранные монеты и настройки

## Последние улучшения (2025-04)

- **UserDropdown.vue**: Исправлена и локально реализована директива v-click-outside для закрытия дропдауна по клику вне его области (без глобальной регистрации).
- **SettingsModal.vue**: Полностью переработана структура модального окна:
  - Теперь модалка центрирована, а затемнённый фон занимает весь экран, не мешая клику вне окна.
  - Закрытие модалки теперь работает как по клику на фон, так и по клику вне окна (через v-click-outside и @mousedown.self).
- Улучшен UX: модальные окна и дропдауны закрываются ожидаемым образом, код компонентов стал чище и надёжнее.

## Отображение иконок криптовалют

- Основной CDN: [binance-icons](https://github.com/VadimMalykhin/binance-icons) через CDN:
  `https://cdn.jsdelivr.net/gh/vadimmalykhin/binance-icons/crypto/[base_asset].svg`
- Fallback: https://cryptoicons.org/api/icon/[base_asset]/32
- Если иконка не найдена — серая иконка FontAwesome (`fa-circle-question`)
- Для корректной работы FontAwesome подключите CDN:
  `<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">`

## TODO
- Избранные монеты: отдельный список, не фильтруются, localStorage/профиль
- Drag-and-drop сортировка монет
- добавить открытый интерес
- добавить возможность добавления монет в избранное
- добавить возможность удаления монет из избранного
- добавить возможность редактирования монет в избранном

---

_Для подробностей см. комментарии в исходных файлах и описание компонентов._
